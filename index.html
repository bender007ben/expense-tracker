<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ausgaben Archiv CH</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Mode Variables */
            --paper-base: #e8e6e1;
            --paper-shadow-light: #ffffff;
            --paper-shadow-dark: #b8b6b1;
            --text-main: #1a1a1a;
            --text-muted: rgba(26, 26, 26, 0.4);
            --accent-rose: #9f1239;
            --accent-emerald: #065f46;
            --deboss-depth: 4px;
            --bg-input: rgba(0,0,0,0.05);
            --nav-bg: #e8e6e1;
        }

        body.dark-mode {
            /* Dark Mode Variables */
            --paper-base: #1c1c1c;
            --paper-shadow-light: #2d2d2d;
            --paper-shadow-dark: #0a0a0a;
            --text-main: #e0e0e0;
            --text-muted: rgba(224, 224, 224, 0.4);
            --accent-rose: #fb7185;
            --accent-emerald: #34d399;
            --bg-input: rgba(255,255,255,0.05);
            --nav-bg: #1c1c1c;
        }

        body {
            background-color: var(--paper-base);
            font-family: 'Outfit', sans-serif;
            color: var(--text-main);
            overflow-x: hidden;
            overscroll-behavior-y: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .deboss-container {
            background: var(--paper-base);
            box-shadow: 
                inset var(--deboss-depth) var(--deboss-depth) calc(var(--deboss-depth) * 2) var(--paper-shadow-dark),
                inset calc(var(--deboss-depth) * -1) calc(var(--deboss-depth) * -1) calc(var(--deboss-depth) * 2) var(--paper-shadow-light);
            border-radius: 2px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .heading-stamp {
            letter-spacing: 0.2em;
            font-weight: 800;
            text-transform: uppercase;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--paper-shadow-dark); border-radius: 10px; }

        .btn-press:active { transform: scale(0.96); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        .bg-theme-base { background-color: var(--paper-base); }
        .text-theme-main { color: var(--text-main); }
        .text-theme-muted { color: var(--text-muted); }
        .border-theme-muted { border-color: var(--text-muted); }
        .bg-theme-input { background-color: var(--bg-input); }

        #root:empty::before {
            content: 'Lade System...';
            display: block;
            text-align: center;
            padding-top: 20vh;
            font-family: 'JetBrains Mono', monospace;
            opacity: 0.5;
            color: #888;
        }
        
        input[type="date"], select, input {
            color: var(--text-main);
            background: transparent;
        }
        
        input[type="date"] {
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            color-scheme: light; 
        }
        
        body.dark-mode input[type="date"] {
            color-scheme: dark;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const IconTrash2 = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>);
        const IconEdit3 = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>);
        const IconTrendingUp = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>);
        const IconTrendingDown = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>);
        const IconArchive = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>);
        const IconSettings = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
        const IconBarChart3 = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>);
        const IconPlus = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>);
        const IconX = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>);
        const IconWallet = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>);
        const IconPieChart = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>);
        const IconChevronDown = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>);
        const IconMoon = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>);
        const IconSun = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>);
        const IconCheck = ({ size = 24, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>);

        // --- COMPONENTS ---

        const StatsCard = ({ title, amount, icon: Icon, colorClass }) => (
            <div className="deboss-container p-3 md:p-4 flex flex-col justify-center items-center text-center h-full">
                <span className="text-[9px] md:text-[10px] font-bold uppercase mb-1 md:mb-2 text-theme-muted flex items-center gap-1">
                {title} {Icon && <Icon size={10} className="md:w-3 md:h-3"/>}
                </span>
                <span className={`text-sm md:text-xl font-mono font-medium truncate w-full ${colorClass}`}>
                {amount}
                </span>
            </div>
        );

        const TransactionItem = ({ t, formatMoney, handleDelete, handleEdit, isSelected, onSelect }) => (
            <div 
                onClick={() => onSelect(t.id)}
                className={`group relative flex justify-between items-center pb-3 md:pb-4 border-b transition-colors rounded select-none cursor-pointer 
                    ${isSelected ? 'bg-theme-input' : 'hover:bg-theme-input'}
                `}
                style={{ borderColor: 'var(--text-muted)' }}
            >
                <div className="flex flex-col max-w-[60%]">
                    <span className="font-mono text-[9px] md:text-[10px] text-theme-muted mb-1">{t.date}</span>
                    <span className="font-bold text-xs md:text-sm uppercase tracking-wide truncate text-theme-main">{t.desc}</span>
                </div>
                <div className="text-right flex flex-col items-end">
                    <span className={`font-mono text-sm md:text-lg block ${t.type === 'income' ? 'text-[var(--accent-emerald)]' : 'text-theme-main'}`}>
                        {t.amount > 0 ? '+' : ''}{formatMoney(t.amount)}
                    </span>
                    <div className="flex flex-wrap justify-end gap-1 mt-1">
                        <span className="text-[8px] md:text-[10px] font-bold text-theme-muted uppercase bg-theme-input px-1 rounded">
                            {t.category}
                        </span>
                        {t.subcategory && (
                            <span className="text-[8px] md:text-[10px] font-bold text-theme-main uppercase bg-theme-input px-1 rounded opacity-60">
                                {t.subcategory}
                            </span>
                        )}
                    </div>
                </div>
                
                {/* Actions container */}
                <div className={`
                    absolute right-0 top-1/2 -translate-y-1/2 
                    flex items-center gap-2 pr-2 shadow-sm z-20 transition-all duration-300 rounded
                    ${isSelected ? 'opacity-100 visible translate-x-0' : 'opacity-0 invisible translate-x-4 pointer-events-none'}
                `} style={{ background: 'var(--paper-base)' }}>
                    <button 
                        onClick={(e) => { 
                            e.stopPropagation(); 
                            if(isSelected) handleEdit(t); 
                        }}
                        className="p-2 text-theme-muted hover:text-theme-main hover:bg-theme-input rounded-full transition-colors"
                    >
                        <IconEdit3 size={16} />
                    </button>
                    <button 
                        onClick={(e) => { 
                            e.stopPropagation(); 
                            if(isSelected) handleDelete(t.id); 
                        }}
                        className="p-2 text-[var(--accent-rose)] hover:bg-theme-input rounded-full transition-colors"
                    >
                        <IconTrash2 size={16} />
                    </button>
                </div>
            </div>
        );

        // --- HELPERS ---
        const loadFromLS = (key, defaultValue) => {
            try {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : defaultValue;
            } catch (e) {
                return defaultValue;
            }
        };

        const MONTH_NAMES = [
            "Januar", "Februar", "März", "April", "Mai", "Juni", 
            "Juli", "August", "September", "Oktober", "November", "Dezember"
        ];

        // --- MAIN APP ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('overview'); 
            const [isMobileFormOpen, setIsMobileFormOpen] = useState(false);
            const [selectedTransactionId, setSelectedTransactionId] = useState(null);

            // Settings
            const [isDarkMode, setIsDarkMode] = useState(() => loadFromLS('darkMode', false));

            // Filters
            const [timeFilter, setTimeFilter] = useState('month'); 
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());

            // Data
            const [transactions, setTransactions] = useState(() => loadFromLS('transactions', [
                { id: 1, desc: "Cloud Infrastruktur", amount: -240.00, date: "2023-10-24", type: "expense", category: "Technik", subcategory: "Server" },
                { id: 2, desc: "Studio Equipment", amount: -1120.50, date: "2023-10-22", type: "expense", category: "Investition", subcategory: "" },
            ]));

            // CATEGORIES: Migration Logic for old string arrays
            const [categories, setCategories] = useState(() => {
                const loaded = loadFromLS('categories', null);
                const defaultCats = [
                    { id: 'c1', name: 'Wohnen', subs: ['Miete', 'Strom'] },
                    { id: 'c2', name: 'Verpflegung', subs: ['Einkauf', 'Restaurant'] },
                    { id: 'c3', name: 'Technik', subs: [] },
                    { id: 'c4', name: 'Freizeit', subs: [] },
                    { id: 'c5', name: 'Transport', subs: ['ÖV', 'Auto'] },
                    { id: 'c6', name: 'Investition', subs: [] },
                    { id: 'c7', name: 'Sonstiges', subs: [] }
                ];

                if (!loaded) return defaultCats;
                
                // If old format (array of strings), convert to object structure
                if (loaded.length > 0 && typeof loaded[0] === 'string') {
                    return loaded.map((cat, i) => ({
                        id: `migrated_${i}`,
                        name: cat,
                        subs: []
                    }));
                }
                return loaded;
            });

            const [budgetLimit, setBudgetLimit] = useState(() => loadFromLS('budgetLimit', 2000));

            // Form Fields
            const [newDesc, setNewDesc] = useState("");
            const [newAmount, setNewAmount] = useState("");
            const [newType, setNewType] = useState("expense");
            const [newCategory, setNewCategory] = useState(categories[0]?.name || "");
            const [newSubCategory, setNewSubCategory] = useState("");
            const [newDate, setNewDate] = useState(new Date().toISOString().split('T')[0]);
            
            const [editingId, setEditingId] = useState(null);
            
            // Category Management States
            const [editingCatId, setEditingCatId] = useState(null);
            const [editCatName, setEditCatName] = useState("");
            const [newMainCatName, setNewMainCatName] = useState("");
            const [newSubInput, setNewSubInput] = useState("");

            // --- EFFECTS ---

            useEffect(() => {
                localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
                if (isDarkMode) { document.body.classList.add('dark-mode'); } 
                else { document.body.classList.remove('dark-mode'); }
            }, [isDarkMode]);

            useEffect(() => {
                const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem('transactions', JSON.stringify(sorted));
            }, [transactions]);

            useEffect(() => {
                localStorage.setItem('categories', JSON.stringify(categories));
            }, [categories]);

            useEffect(() => {
                localStorage.setItem('budgetLimit', JSON.stringify(budgetLimit));
            }, [budgetLimit]);

            // --- COMPUTED ---
            const availableYears = useMemo(() => {
                const years = new Set([new Date().getFullYear()]);
                transactions.forEach(t => years.add(new Date(t.date).getFullYear()));
                return Array.from(years).sort((a, b) => b - a);
            }, [transactions]);

            const filteredTransactions = useMemo(() => {
                const now = new Date();
                const getWeek = (d) => {
                    const date = new Date(d.getTime());
                    date.setHours(0, 0, 0, 0);
                    date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                    const week1 = new Date(date.getFullYear(), 0, 4);
                    return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                };
                const currentWeek = getWeek(now);

                if (timeFilter === 'all') return transactions;

                return transactions.filter(t => {
                    const tDate = new Date(t.date);
                    const tYear = tDate.getFullYear();
                    const tMonth = tDate.getMonth();

                    if (timeFilter === 'year') return tYear === parseInt(filterYear);
                    if (timeFilter === 'month') return tYear === parseInt(filterYear) && tMonth === parseInt(filterMonth);
                    if (timeFilter === 'week') return tYear === now.getFullYear() && getWeek(tDate) === currentWeek;
                    return true;
                });
            }, [transactions, timeFilter, filterMonth, filterYear]);

            // Stats
            const totalIncomeFiltered = filteredTransactions.filter(t => t.amount > 0).reduce((acc, curr) => acc + curr.amount, 0);
            const totalExpenseFiltered = Math.abs(filteredTransactions.filter(t => t.amount < 0).reduce((acc, curr) => acc + curr.amount, 0));
            const totalBalanceGlobal = transactions.reduce((acc, curr) => acc + curr.amount, 0);
            const budgetProgress = Math.min((totalExpenseFiltered / budgetLimit) * 100, 100);

            const expensesByCategory = useMemo(() => {
                const categoriesMap = {};
                filteredTransactions.filter(t => t.type === 'expense').forEach(t => {
                    const cat = t.category || 'Sonstiges';
                    categoriesMap[cat] = (categoriesMap[cat] || 0) + Math.abs(t.amount);
                });
                return Object.entries(categoriesMap).sort((a, b) => b[1] - a[1]);
            }, [filteredTransactions]);

            const formatMoney = (amount) => {
                return new Intl.NumberFormat('de-CH', { style: 'currency', currency: 'CHF' }).format(amount);
            };

            const getTitleSuffix = () => {
                if(timeFilter === 'week') return 'Woche';
                if(timeFilter === 'year') return `${filterYear}`;
                if(timeFilter === 'month') return `${MONTH_NAMES[filterMonth]} ${filterYear}`;
                return 'Gesamt';
            }

            // --- CATEGORY MANAGEMENT HANDLERS ---
            const handleAddMainCategory = () => {
                if(newMainCatName && !categories.find(c => c.name === newMainCatName)) {
                    setCategories([...categories, { id: Date.now().toString(), name: newMainCatName, subs: [] }]);
                    setNewMainCatName("");
                }
            };

            const startEditCategory = (cat) => {
                setEditingCatId(cat.id);
                setEditCatName(cat.name);
            };

            const saveEditCategory = (id) => {
                setCategories(categories.map(c => c.id === id ? { ...c, name: editCatName } : c));
                setEditingCatId(null);
            };

            const addSubCategory = (catId, subName) => {
                if(!subName) return;
                setCategories(categories.map(c => {
                    if (c.id === catId && !c.subs.includes(subName)) {
                        return { ...c, subs: [...c.subs, subName] };
                    }
                    return c;
                }));
                setNewSubInput(""); // Clear general input just in case, though mostly local would be better
            };

            const removeSubCategory = (catId, subName) => {
                if(window.confirm(`Unterkategorie "${subName}" löschen?`)) {
                    setCategories(categories.map(c => c.id === catId ? { ...c, subs: c.subs.filter(s => s !== subName) } : c));
                }
            };

            const deleteMainCategory = (id) => {
                if(window.confirm("Kategorie löschen? (Buchungen bleiben erhalten)")) {
                    setCategories(categories.filter(c => c.id !== id));
                }
            };

            // --- TRANSACTION HANDLERS ---
            const handleSaveTransaction = () => {
                if (!newDesc || !newAmount || !newDate) return;
                
                const amountVal = parseFloat(newAmount);
                const finalAmount = newType === 'expense' ? -Math.abs(amountVal) : Math.abs(amountVal);
                
                const txData = {
                    desc: newDesc,
                    amount: finalAmount,
                    date: newDate,
                    type: newType,
                    category: newType === 'income' ? 'Einkommen' : newCategory,
                    subcategory: newType === 'income' ? '' : newSubCategory
                };

                if (editingId) {
                    setTransactions(transactions.map(t => t.id === editingId ? { ...t, ...txData } : t));
                    setEditingId(null);
                } else {
                    setTransactions([{ id: Date.now(), ...txData }, ...transactions]);
                }

                setNewDesc(""); setNewAmount(""); setNewDate(new Date().toISOString().split('T')[0]);
                setNewSubCategory("");
                setIsMobileFormOpen(false); setSelectedTransactionId(null);
            };

            const startEditing = (t) => {
                setEditingId(t.id);
                setNewDesc(t.desc);
                setNewAmount(Math.abs(t.amount).toString());
                setNewType(t.type);
                setNewCategory(t.category);
                setNewSubCategory(t.subcategory || "");
                setNewDate(t.date);
                setActiveTab('overview');
                setIsMobileFormOpen(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelEdit = () => {
                setEditingId(null); setNewDesc(""); setNewAmount(""); setNewDate(new Date().toISOString().split('T')[0]); setNewSubCategory("");
                setIsMobileFormOpen(false);
            };

            const handleDelete = (id) => {
                setTransactions(transactions.filter(t => t.id !== id));
                if(selectedTransactionId === id) setSelectedTransactionId(null);
                if(editingId === id) cancelEdit();
            };

            const handleSelectTransaction = (id) => {
                setSelectedTransactionId(selectedTransactionId === id ? null : id);
            };

            const handleResetData = () => {
                if(window.confirm("Wirklich alle Daten löschen?")) { setTransactions([]); }
            };

            // Get available subcategories based on selection
            const currentSubCategories = useMemo(() => {
                const cat = categories.find(c => c.name === newCategory);
                return cat ? cat.subs : [];
            }, [categories, newCategory]);

            return (
                <div className="min-h-screen relative pb-24 lg:pb-0" onClick={() => setSelectedTransactionId(null)}>
                    
                    {/* Grain Filter Overlay */}
                    <div id="grain-overlay" className="fixed top-0 left-0 w-[120%] h-[120%] pointer-events-none z-0 opacity-[0.12] mix-blend-multiply dark:mix-blend-overlay" style={{marginLeft: '-10%', marginTop: '-10%'}}>
                        <svg className="w-full h-full">
                            <filter id="noiseFilter">
                                <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/>
                                <feColorMatrix type="saturate" values="0"/>
                            </filter>
                            <rect width="100%" height="100%" filter="url(#noiseFilter)"/>
                        </svg>
                    </div>

                    <main className="w-full max-w-6xl mx-auto grid grid-cols-12 gap-8 p-4 md:p-12 relative z-10" onClick={(e) => e.stopPropagation()}>
                        
                        {/* Desktop Sidebar */}
                        <aside className="hidden lg:flex col-span-3 flex-col justify-between py-4 h-[calc(100vh-6rem)] sticky top-12">
                            <div>
                                <h1 className="heading-stamp text-2xl mb-12 leading-none border-l-4 border-theme-muted pl-4">
                                    Ausgaben<br/>Archiv
                                </h1>
                                <nav className="space-y-6">
                                    <button onClick={() => setActiveTab('overview')} className={`flex items-center gap-3 text-sm font-bold w-full text-left transition-all text-theme-main ${activeTab === 'overview' ? 'opacity-100 border-b-2 border-theme-muted pb-1' : 'opacity-40 hover:opacity-100'}`}>
                                        <IconArchive size={16} /> 01. ÜBERSICHT
                                    </button>
                                    <button onClick={() => setActiveTab('analytics')} className={`flex items-center gap-3 text-sm font-bold w-full text-left transition-all text-theme-main ${activeTab === 'analytics' ? 'opacity-100 border-b-2 border-theme-muted pb-1' : 'opacity-40 hover:opacity-100'}`}>
                                        <IconBarChart3 size={16} /> 02. ANALYSE
                                    </button>
                                    <button onClick={() => setActiveTab('settings')} className={`flex items-center gap-3 text-sm font-bold w-full text-left transition-all text-theme-main ${activeTab === 'settings' ? 'opacity-100 border-b-2 border-theme-muted pb-1' : 'opacity-40 hover:opacity-100'}`}>
                                        <IconSettings size={16} /> 03. EINSTELLUNGEN
                                    </button>
                                </nav>
                            </div>
                            <div>
                                <p className="text-[10px] font-mono uppercase text-theme-muted leading-relaxed">
                                    System: Online<br/>Ref: 992-001-CH
                                </p>
                            </div>
                        </aside>

                        {/* Mobile Header */}
                        <div className="lg:hidden col-span-12 flex justify-between items-center mb-2">
                            <h1 className="heading-stamp text-lg leading-none border-l-4 border-theme-muted pl-3">
                                Ausgaben<br/>Archiv
                            </h1>
                        </div>

                        {/* --- CONTENT AREA --- */}
                        <section className="col-span-12 lg:col-span-9 min-h-[80vh]">
                            
                            {/* OVERVIEW TAB */}
                            {activeTab === 'overview' && (
                                <div className="space-y-6 md:space-y-8 animate-in fade-in duration-300">
                                    
                                    {/* TIME FILTER */}
                                    <div className="space-y-2">
                                        <div className="deboss-container p-1 flex justify-between gap-1">
                                            {['week', 'month', 'year', 'all'].map(filter => (
                                                <button 
                                                    key={filter}
                                                    onClick={() => setTimeFilter(filter)}
                                                    className={`
                                                        flex-1 py-2 text-[10px] md:text-xs font-bold uppercase tracking-widest transition-all rounded-sm
                                                        ${timeFilter === filter ? 'bg-theme-input text-theme-main shadow-sm border border-theme-muted' : 'text-theme-muted hover:text-theme-main hover:bg-theme-input'}
                                                    `}
                                                >
                                                    {filter === 'week' ? 'Woche' : filter === 'month' ? 'Monat' : filter === 'year' ? 'Jahr' : 'Alle'}
                                                </button>
                                            ))}
                                        </div>

                                        {(timeFilter === 'month' || timeFilter === 'year') && (
                                            <div className="flex gap-2 animate-in fade-in slide-in-from-top-1">
                                                {timeFilter === 'month' && (
                                                    <div className="relative flex-1">
                                                        <select 
                                                            value={filterMonth} 
                                                            onChange={(e) => setFilterMonth(e.target.value)}
                                                            className="w-full bg-theme-input border-b border-theme-muted text-xs font-bold uppercase py-2 px-3 outline-none cursor-pointer hover:opacity-80 transition-colors"
                                                        >
                                                            {MONTH_NAMES.map((m, i) => (
                                                                <option key={i} value={i}>{m}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                )}
                                                <div className="relative flex-1">
                                                    <select 
                                                        value={filterYear} 
                                                        onChange={(e) => setFilterYear(e.target.value)}
                                                        className="w-full bg-theme-input border-b border-theme-muted text-xs font-bold uppercase py-2 px-3 outline-none cursor-pointer hover:opacity-80 transition-colors"
                                                    >
                                                        {availableYears.map(y => (
                                                            <option key={y} value={y}>{y}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Stats */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                                        <div className="deboss-container p-6 md:p-8 flex flex-col justify-between min-h-[160px] md:min-h-[200px]">
                                            <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest text-theme-muted flex items-center gap-2">
                                                <IconWallet size={14} /> Aktueller Kontostand
                                            </span>
                                            <div>
                                                <span className={`text-4xl md:text-6xl font-mono font-medium tracking-tighter ${totalBalanceGlobal < 0 ? 'text-[var(--accent-rose)]' : ''}`}>
                                                    {formatMoney(totalBalanceGlobal)}
                                                </span>
                                            </div>
                                            <span className="text-[9px] uppercase text-theme-muted mt-2">Gesamtsaldo (Ungefiltert)</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 md:gap-4">
                                            <StatsCard title="Einnahmen" amount={`+${formatMoney(totalIncomeFiltered)}`} icon={IconTrendingUp} colorClass="text-[var(--accent-emerald)]" />
                                            <StatsCard title="Ausgaben" amount={`-${formatMoney(totalExpenseFiltered)}`} icon={IconTrendingDown} colorClass="text-[var(--accent-rose)]" />
                                            
                                            <div className="col-span-2 deboss-container p-4 md:p-6 flex flex-col justify-center relative overflow-hidden">
                                                <div className="flex justify-between items-end mb-2 z-10 relative">
                                                    <span className="text-[9px] md:text-[10px] font-bold uppercase text-theme-muted">Budget ({timeFilter === 'all' ? '∞' : formatMoney(budgetLimit)})</span>
                                                    <span className="font-mono text-xs opacity-70">{Math.round(budgetProgress)}%</span>
                                                </div>
                                                <div className="absolute left-0 bottom-0 h-1 bg-theme-input w-full">
                                                    <div className={`h-full transition-all duration-1000 ${budgetProgress > 100 ? 'bg-rose-800' : 'bg-stone-800 dark:bg-stone-200'}`} style={{ width: `${budgetProgress > 100 ? 100 : budgetProgress}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8 items-start">
                                        {/* List */}
                                        <div className="lg:col-span-2 deboss-container h-[400px] md:h-[550px] flex flex-col relative order-2 lg:order-1">
                                            <div className="p-4 md:p-6 border-b border-theme-muted flex justify-between items-center bg-theme-input backdrop-blur-sm z-10 sticky top-0">
                                                <h3 className="text-[10px] md:text-xs font-bold uppercase tracking-widest">
                                                    Journal ({getTitleSuffix()})
                                                </h3>
                                                <span className="font-mono text-[9px] md:text-[10px] text-theme-muted hidden md:inline">SORT: DATUM</span>
                                            </div>
                                            <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 md:space-y-6 custom-scroll">
                                                {filteredTransactions.length === 0 ? (
                                                    <div className="h-full flex flex-col items-center justify-center text-theme-muted font-mono text-xs uppercase text-center p-4">
                                                        <IconArchive size={32} className="mb-2 opacity-50"/>Keine Einträge
                                                    </div>
                                                ) : (
                                                    filteredTransactions.map((t) => (
                                                        <TransactionItem 
                                                            key={t.id} 
                                                            t={t} 
                                                            formatMoney={formatMoney} 
                                                            handleDelete={handleDelete}
                                                            handleEdit={startEditing}
                                                            isSelected={selectedTransactionId === t.id}
                                                            onSelect={handleSelectTransaction}
                                                        />
                                                    ))
                                                )}
                                            </div>
                                        </div>

                                        {/* Form */}
                                        <div className={`space-y-6 lg:sticky lg:top-6 order-1 lg:order-2 ${isMobileFormOpen ? 'block' : 'hidden lg:block'}`}>
                                            <div className="deboss-container p-4 md:p-6 shadow-lg lg:shadow-none border border-theme-muted lg:border-none relative" style={{ backgroundColor: 'var(--paper-base)' }}>
                                                <button onClick={() => {setIsMobileFormOpen(false); cancelEdit();}} className="absolute top-2 right-2 p-2 lg:hidden text-theme-muted">
                                                    <IconX size={20} />
                                                </button>
                                                <h3 className="text-xs font-bold uppercase tracking-widest mb-6 flex items-center gap-2">
                                                    {editingId ? <IconEdit3 size={14} /> : <IconPlus size={14} />} 
                                                    {editingId ? 'Eintrag Bearbeiten' : 'Neuer Eintrag'}
                                                </h3>
                                                <div className="space-y-5">
                                                    <div className="flex bg-theme-input p-1 rounded-sm">
                                                        <button onClick={() => setNewType('expense')} className={`flex-1 py-3 lg:py-2 text-[10px] font-bold uppercase tracking-widest transition-all ${newType === 'expense' ? 'bg-theme-input shadow-sm text-[var(--accent-rose)]' : 'text-theme-muted'}`}>Ausgabe</button>
                                                        <button onClick={() => setNewType('income')} className={`flex-1 py-3 lg:py-2 text-[10px] font-bold uppercase tracking-widest transition-all ${newType === 'income' ? 'bg-theme-input shadow-sm text-[var(--accent-emerald)]' : 'text-theme-muted'}`}>Einnahme</button>
                                                    </div>
                                                    
                                                    {/* DATE INPUT */}
                                                    <div>
                                                        <label className="text-[10px] font-bold text-theme-muted block mb-1 uppercase">Datum</label>
                                                        <input type="date" value={newDate} onChange={(e) => setNewDate(e.target.value)} className="w-full bg-transparent border-b border-theme-muted focus:border-black dark:focus:border-white outline-none font-mono py-2 text-sm uppercase transition-colors rounded-none cursor-pointer" />
                                                    </div>

                                                    <div>
                                                        <label className="text-[10px] font-bold text-theme-muted block mb-1 uppercase">Beschreibung</label>
                                                        <input type="text" value={newDesc} onChange={(e) => setNewDesc(e.target.value)} placeholder="Z.B. BÜROMATERIAL" className="w-full bg-transparent border-b border-theme-muted focus:border-black dark:focus:border-white outline-none font-mono py-2 text-sm uppercase transition-colors rounded-none" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-theme-muted block mb-1 uppercase">Betrag (CHF)</label>
                                                        <input type="number" inputMode="decimal" value={newAmount} onChange={(e) => setNewAmount(e.target.value)} placeholder="0.00" className="w-full bg-transparent border-b border-theme-muted focus:border-black dark:focus:border-white outline-none font-mono py-2 text-xl transition-colors rounded-none" />
                                                    </div>
                                                    
                                                    {newType === 'expense' && (
                                                        <div className="space-y-4">
                                                            <div>
                                                                <label className="text-[10px] font-bold text-theme-muted block mb-1 uppercase">Kategorie</label>
                                                                <div className="relative">
                                                                    <select value={newCategory} onChange={(e) => { setNewCategory(e.target.value); setNewSubCategory(""); }} className="w-full bg-transparent border-b border-theme-muted focus:border-black dark:focus:border-white outline-none font-mono py-2 text-sm uppercase transition-colors appearance-none rounded-none">
                                                                        {categories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                                                    </select>
                                                                    <IconChevronDown size={14} className="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-theme-muted"/>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Subcategory Selector (Conditional) */}
                                                            {currentSubCategories.length > 0 && (
                                                                <div className="animate-in fade-in slide-in-from-top-2">
                                                                    <label className="text-[10px] font-bold text-theme-muted block mb-1 uppercase">Unterkategorie</label>
                                                                    <div className="relative">
                                                                        <select value={newSubCategory} onChange={(e) => setNewSubCategory(e.target.value)} className="w-full bg-transparent border-b border-theme-muted focus:border-black dark:focus:border-white outline-none font-mono py-2 text-sm uppercase transition-colors appearance-none rounded-none">
                                                                            <option value="">- Keine -</option>
                                                                            {currentSubCategories.map(s => <option key={s} value={s}>{s}</option>)}
                                                                        </select>
                                                                        <IconChevronDown size={14} className="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-theme-muted"/>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}

                                                    <div className="pt-4 flex gap-2">
                                                        {editingId && (
                                                            <button onClick={cancelEdit} className="flex-1 bg-transparent border border-theme-muted text-theme-muted py-4 font-bold text-xs uppercase tracking-[0.2em] hover:bg-theme-input transition-colors">
                                                                Abbrechen
                                                            </button>
                                                        )}
                                                        <button onClick={handleSaveTransaction} className={`flex-1 bg-black dark:bg-white text-white dark:text-black py-4 font-bold text-xs uppercase tracking-[0.2em] hover:opacity-80 transition-colors shadow-lg active:scale-95 ${editingId ? 'w-2/3' : 'w-full'}`}>
                                                            {editingId ? 'Update' : 'Buchen'}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ANALYTICS TAB */}
                            {activeTab === 'analytics' && (
                                <div className="space-y-8 animate-in fade-in duration-300">
                                    <div className="deboss-container p-6 md:p-8">
                                        <h2 className="heading-stamp text-xl mb-8 border-b border-theme-muted pb-4">
                                            Ausgaben Analyse ({getTitleSuffix()})
                                        </h2>
                                        {expensesByCategory.length === 0 ? (
                                            <div className="text-center py-12 text-theme-muted font-mono">Keine Ausgabendaten verfügbar</div>
                                        ) : (
                                            <div className="space-y-6">
                                                {expensesByCategory.map(([cat, amount]) => {
                                                    const percent = ((amount / totalExpenseFiltered) * 100);
                                                    return (
                                                        <div key={cat} className="space-y-2">
                                                            <div className="flex justify-between items-end text-xs uppercase font-bold tracking-wider">
                                                                <span>{cat}</span>
                                                                <span className="font-mono text-theme-muted">{Math.round(percent)}%</span>
                                                            </div>
                                                            <div className="h-8 bg-theme-input relative w-full rounded-sm overflow-hidden flex items-center px-2">
                                                                <div className="absolute left-0 top-0 h-full bg-black dark:bg-white opacity-80" style={{ width: `${percent}%` }}></div>
                                                                <span className="relative z-10 font-mono text-xs mix-blend-difference text-white dark:text-black">{formatMoney(amount)}</span>
                                                            </div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="deboss-container p-6">
                                            <h3 className="text-xs font-bold uppercase tracking-widest mb-4 text-theme-muted">Größte Ausgabe</h3>
                                            <div className="text-2xl font-mono mb-1">
                                                {filteredTransactions.filter(t => t.type === 'expense').length > 0 ? formatMoney(Math.max(...filteredTransactions.filter(t => t.type === 'expense').map(t => Math.abs(t.amount)))) : '-'}
                                            </div>
                                        </div>
                                        <div className="deboss-container p-6">
                                            <h3 className="text-xs font-bold uppercase tracking-widest mb-4 text-theme-muted">Durchschnitt / Eintrag</h3>
                                            <div className="text-2xl font-mono mb-1">
                                                {filteredTransactions.filter(t => t.type === 'expense').length > 0 ? formatMoney(totalExpenseFiltered / filteredTransactions.filter(t => t.type === 'expense').length) : '-'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* SETTINGS TAB */}
                            {activeTab === 'settings' && (
                                <div className="space-y-8 animate-in fade-in duration-300 max-w-2xl mx-auto">
                                    <div className="deboss-container p-6 md:p-8">
                                        <h2 className="heading-stamp text-xl mb-8 border-b border-theme-muted pb-4">Einstellungen</h2>
                                        
                                        <div className="space-y-8">
                                            {/* DARK MODE TOGGLE */}
                                            <div className="flex items-center justify-between">
                                                <label className="text-xs font-bold uppercase tracking-widest">Dunkelmodus</label>
                                                <button 
                                                    onClick={() => setIsDarkMode(!isDarkMode)}
                                                    className="bg-theme-input p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors"
                                                >
                                                    {isDarkMode ? <IconSun size={20} /> : <IconMoon size={20} />}
                                                </button>
                                            </div>

                                            <div>
                                                <label className="text-xs font-bold uppercase tracking-widest block mb-3">Monatliches Budget Ziel</label>
                                                <div className="flex items-center gap-4">
                                                    <input type="number" value={budgetLimit} onChange={(e) => setBudgetLimit(Number(e.target.value))} className="bg-transparent border-b-2 border-theme-muted focus:border-black dark:focus:border-white outline-none font-mono text-2xl py-2 w-full transition-colors rounded-none" />
                                                    <span className="font-mono text-xl text-theme-muted">CHF</span>
                                                </div>
                                            </div>

                                            {/* CATEGORY MANAGEMENT */}
                                            <div className="pt-8 border-t border-theme-muted">
                                                <label className="text-xs font-bold uppercase tracking-widest block mb-4">Kategorien Verwalten</label>
                                                
                                                {/* Add Main Category */}
                                                <div className="flex gap-2 mb-6">
                                                    <input 
                                                        type="text" 
                                                        value={newMainCatName} 
                                                        onChange={(e) => setNewMainCatName(e.target.value)}
                                                        placeholder="NEUE HAUPTKATEGORIE" 
                                                        className="flex-1 bg-theme-input px-3 py-2 font-mono text-sm uppercase outline-none focus:bg-white dark:focus:bg-black transition-colors"
                                                    />
                                                    <button onClick={handleAddMainCategory} className="bg-black dark:bg-white text-white dark:text-black px-4 py-2 font-bold text-xs uppercase"><IconPlus size={16}/></button>
                                                </div>
                                                
                                                <div className="grid grid-cols-1 gap-4">
                                                    {categories.map(cat => (
                                                        <div key={cat.id} className="bg-theme-input p-4 border border-theme-muted flex flex-col gap-3">
                                                            
                                                            {/* Main Cat Header */}
                                                            <div className="flex justify-between items-center">
                                                                {editingCatId === cat.id ? (
                                                                    <div className="flex gap-2 flex-1 mr-2">
                                                                        <input 
                                                                            value={editCatName} 
                                                                            onChange={(e) => setEditCatName(e.target.value)}
                                                                            className="flex-1 bg-white dark:bg-black px-2 py-1 font-mono text-sm border border-theme-muted"
                                                                        />
                                                                        <button onClick={() => saveEditCategory(cat.id)} className="text-[var(--accent-emerald)]"><IconCheck size={16}/></button>
                                                                    </div>
                                                                ) : (
                                                                    <span className="font-mono text-sm font-bold uppercase">{cat.name}</span>
                                                                )}
                                                                
                                                                <div className="flex gap-2">
                                                                    <button onClick={() => startEditCategory(cat)} className="text-theme-muted hover:text-theme-main"><IconEdit3 size={14}/></button>
                                                                    <button onClick={() => deleteMainCategory(cat.id)} className="text-theme-muted hover:text-[var(--accent-rose)]"><IconTrash2 size={14}/></button>
                                                                </div>
                                                            </div>

                                                            {/* Subcategories List */}
                                                            <div className="flex flex-wrap gap-2">
                                                                {cat.subs.map(sub => (
                                                                    <div key={sub} className="flex items-center gap-1 bg-white dark:bg-black px-2 py-1 border border-theme-muted text-[10px] uppercase font-mono rounded">
                                                                        {sub}
                                                                        <button onClick={() => removeSubCategory(cat.id, sub)} className="hover:text-[var(--accent-rose)] ml-1"><IconX size={10}/></button>
                                                                    </div>
                                                                ))}
                                                            </div>

                                                            {/* Add Subcategory Input */}
                                                            <div className="flex gap-2 mt-1">
                                                                <input 
                                                                    placeholder="Neue Unterkategorie..."
                                                                    className="flex-1 bg-transparent border-b border-theme-muted text-[10px] py-1 font-mono uppercase focus:border-black dark:focus:border-white outline-none"
                                                                    onKeyDown={(e) => {
                                                                        if(e.key === 'Enter') {
                                                                            addSubCategory(cat.id, e.target.value);
                                                                            e.target.value = '';
                                                                        }
                                                                    }}
                                                                />
                                                                <button className="text-theme-muted text-[10px] uppercase hover:text-theme-main" onClick={(e) => {
                                                                    const input = e.currentTarget.previousSibling;
                                                                    addSubCategory(cat.id, input.value);
                                                                    input.value = '';
                                                                }}>+ Add</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="pt-8 border-t border-theme-muted">
                                                <label className="text-xs font-bold uppercase tracking-widest block mb-3 text-[var(--accent-rose)]">Gefahrenzone</label>
                                                <button onClick={handleResetData} className="flex items-center gap-3 px-6 py-4 bg-rose-100/50 dark:bg-rose-900/20 text-rose-900 dark:text-rose-300 font-bold text-xs uppercase tracking-widest hover:bg-rose-200/50 transition-colors w-full md:w-auto">
                                                    <IconTrash2 size={16} /> Alle Daten löschen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </section>
                    </main>

                    {/* Mobile Bottom Navigation */}
                    <nav 
                        className="lg:hidden fixed bottom-0 left-0 w-full border-t border-theme-muted pb-safe pt-2 px-6 z-50 flex justify-between items-center h-20 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] transition-colors duration-300"
                        style={{ backgroundColor: 'var(--nav-bg)' }}
                    >
                        <button onClick={() => { setActiveTab('overview'); setIsMobileFormOpen(false); }} className={`flex flex-col items-center gap-1 p-2 transition-all ${activeTab === 'overview' ? 'opacity-100 scale-105' : 'opacity-40 text-theme-muted'}`}>
                            <IconArchive size={20} strokeWidth={2.5} /><span className="text-[9px] font-bold uppercase tracking-widest">Start</span>
                        </button>
                        <button onClick={() => { setActiveTab('analytics'); setIsMobileFormOpen(false); }} className={`flex flex-col items-center gap-1 p-2 transition-all ${activeTab === 'analytics' ? 'opacity-100 scale-105' : 'opacity-40 text-theme-muted'}`}>
                            <IconPieChart size={20} strokeWidth={2.5} /><span className="text-[9px] font-bold uppercase tracking-widest">Analyse</span>
                        </button>
                        <button onClick={() => { setActiveTab('settings'); setIsMobileFormOpen(false); }} className={`flex flex-col items-center gap-1 p-2 transition-all ${activeTab === 'settings' ? 'opacity-100 scale-105' : 'opacity-40 text-theme-muted'}`}>
                            <IconSettings size={20} strokeWidth={2.5} /><span className="text-[9px] font-bold uppercase tracking-widest">Setup</span>
                        </button>
                    </nav>

                    {/* Mobile FAB */}
                    {!isMobileFormOpen && activeTab === 'overview' && (
                        <button onClick={() => { 
                            setIsMobileFormOpen(true); 
                            setEditingId(null); 
                            setNewDesc(""); setNewAmount(""); setNewDate(new Date().toISOString().split('T')[0]); setNewSubCategory("");
                            window.scrollTo({ top: 0, behavior: 'smooth' }); 
                        }} className="lg:hidden fixed bottom-24 right-6 w-14 h-14 bg-black dark:bg-white text-white dark:text-black rounded-full shadow-2xl flex items-center justify-center z-40 btn-press">
                            <IconPlus size={24} />
                        </button>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


